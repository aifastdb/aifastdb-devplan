---
description: DevPlan 开发计划管理工具。当用户提到开发计划、任务进度、文档管理、或说"开始/继续/恢复/启动 phase-X"时激活。
globs: []
alwaysApply: true
---

# DevPlan — 开发计划管理

## MCP Server

```
mcpServers: aifastdb-devplan
```

## ⚠️ 关键规则：开发阶段触发词识别

**当用户说出以下任何模式时，必须首先调用 `devplan_start_phase` 工具**（将主任务标记为 in_progress）：

| 用户说法示例 | 动作 |
|---|---|
| "请开始 phase-37 的任务" | → `devplan_start_phase(taskId: "phase-37")` |
| "开始 phase-37" / "开始开发 phase-37" | → `devplan_start_phase(taskId: "phase-37")` |
| "开始开发 phase-37 的任务" | → `devplan_start_phase(taskId: "phase-37")` |
| "继续 phase-37" / "继续开发 phase-37" | → `devplan_start_phase(taskId: "phase-37")` |
| "继续开发 phase-37 的任务" | → `devplan_start_phase(taskId: "phase-37")` |
| "恢复 phase-37" / "恢复 phase-37 开发" | → `devplan_start_phase(taskId: "phase-37")` |
| "启动 phase-37" / "启动 phase-37 开发" | → `devplan_start_phase(taskId: "phase-37")` |

**识别规则**：只要用户消息中包含 `phase-` + 数字，且同时包含"开始"、"继续"、"恢复"、"启动"、"start"、"resume"中的任意一个词，就必须调用 `devplan_start_phase`。

**工具是幂等的**：首次调用 = 启动（pending → in_progress），后续调用 = 恢复（已完成子任务保持 completed）。

## 快捷操作

### 初始化 / 查看现有计划
```
devplan_init()                                    # 列出所有已有计划
devplan_init(projectName: "my-project")           # 初始化新计划
```

### 查看项目进度
```
devplan_get_progress(projectName: "<项目名>")
```

### 查看任务列表
```
devplan_list_tasks(projectName: "<项目名>")                             # 列出所有主任务
devplan_list_tasks(projectName: "<项目名>", parentTaskId: "phase-1")    # 指定主任务的子任务
devplan_list_tasks(projectName: "<项目名>", status: "pending")          # 跨所有主任务查询未完成子任务
```

### 创建任务
```
devplan_create_main_task(projectName: "<项目名>", taskId: "phase-1", title: "阶段一", priority: "P0")
devplan_add_sub_task(projectName: "<项目名>", taskId: "T1.1", parentTaskId: "phase-1", title: "子任务")
devplan_upsert_task(...)   # 幂等导入（推荐批量导入使用）
```

### 完成任务
```
devplan_complete_task(projectName: "<项目名>", taskId: "T1.1")         # 完成子任务（自动更新进度）
devplan_complete_task(projectName: "<项目名>", taskId: "phase-1", taskType: "main")  # 手动完成主任务
```

### Git 同步检查
```
devplan_sync_git(projectName: "<项目名>", dryRun: true)   # 先预览
devplan_sync_git(projectName: "<项目名>")                  # 实际执行回退
```

### 文档管理
```
devplan_save_section(projectName: "<项目名>", section: "overview", title: "概述", content: "...")
devplan_list_sections(projectName: "<项目名>")
devplan_get_section(projectName: "<项目名>", section: "overview")
devplan_export_markdown(projectName: "<项目名>", scope: "tasks")
```

### 功能模块
```
devplan_create_module(projectName: "<项目名>", moduleId: "auth", name: "认证模块")
devplan_list_modules(projectName: "<项目名>")
devplan_get_module(projectName: "<项目名>", moduleId: "auth")
```

## 数据存储

数据存储在项目内 `.devplan/` 目录（JSONL 格式），天然跟随 Git 版本管理：

```
.devplan/{projectName}/
├── documents.jsonl    # 文档片段
├── tasks.jsonl        # 主任务 + 子任务
└── modules.jsonl      # 功能模块
```

## 启动/恢复开发阶段

```
devplan_start_phase(projectName: "<项目名>", taskId: "phase-X")
# 自动将主任务标记为 in_progress，返回全部子任务列表（含已完成状态）
# AI 应将返回的子任务创建为 Cursor TodoList（使用 TodoWrite）
# 幂等操作：首次调用=启动，再次调用=恢复（已完成子任务保持 completed）
```

### 开发阶段工作流

1. **启动/恢复**：`devplan_start_phase` → 将子任务转为 TodoWrite（保留已完成状态）→ 输出进度摘要 → 开始第一个 pending 任务
2. **开发中**：完成代码后 → `devplan_complete_task` 回写状态 → 更新 Todo → 继续下一个
3. **阶段完成**：所有子任务完成后，devplan 自动标记主任务为 completed

## 注意事项

1. **通过 MCP 操作任务**：任务状态管理使用 `devplan_*` 系列 MCP 工具，不要手动编辑 JSONL 文件
2. **完成任务后同步**：完成代码实现后，调用 `devplan_complete_task` 持久化状态（自动锚定 Git commit）
3. **Git 回滚后检查**：如果执行了 `git reset` 或切换分支，运行 `devplan_sync_git` 检查任务状态一致性
