<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevPlan Executor â€” è‡ªåŠ¨åŒ–ç›‘æ§</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }
        .container { max-width: 1500px; margin: 0 auto; padding: 16px; }

        /* â”€â”€ Header â”€â”€ */
        header {
            text-align: center; padding: 16px 0; margin-bottom: 16px;
            border-bottom: 1px solid rgba(0,212,255,0.2);
        }
        header h1 { color: #00d4ff; font-size: 1.6em; letter-spacing: 2px; }
        header .subtitle { color: #666; margin-top: 4px; font-size: 0.9em; }
        .header-badges {
            display: flex; justify-content: center; gap: 16px; margin-top: 8px;
        }
        .badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 4px 12px; border-radius: 20px; font-size: 0.8em;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
        }
        .badge .dot {
            width: 8px; height: 8px; border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .badge .dot.green { background: #00ff88; }
        .badge .dot.red { background: #ff4444; }
        .badge .dot.yellow { background: #ffaa00; }
        @keyframes pulse { 0%,100%{ opacity:1 } 50%{ opacity:0.4 } }

        /* â”€â”€ Countdown â”€â”€ */
        .countdown-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 4px 14px; border-radius: 20px; font-size: 0.8em;
            background: rgba(0,212,255,0.08); border: 1px solid rgba(0,212,255,0.25);
            font-family: 'Consolas', 'Fira Code', monospace;
            min-width: 110px; justify-content: center;
        }
        .countdown-badge .countdown-num {
            font-size: 1.15em; font-weight: 700; color: #00d4ff;
            min-width: 20px; text-align: right;
        }
        .countdown-badge.active { border-color: rgba(0,255,136,0.4); background: rgba(0,255,136,0.06); }
        .countdown-badge.active .countdown-num { color: #00ff88; }
        .countdown-ring {
            width: 22px; height: 22px; border-radius: 50%;
            border: 2px solid rgba(0,212,255,0.2); position: relative;
        }
        .countdown-ring-fill {
            position: absolute; inset: -2px; border-radius: 50%;
            border: 2px solid transparent; border-top-color: #00d4ff;
            transition: transform 1s linear;
        }

        /* â”€â”€ Grid â”€â”€ */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }
        @media (max-width: 1200px) { .main-grid { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 800px)  { .main-grid { grid-template-columns: 1fr; } }
        .span-2 { grid-column: span 2; }
        @media (max-width: 800px)  { .span-2 { grid-column: span 1; } }
        .span-3 { grid-column: span 3; }
        @media (max-width: 1200px) { .span-3 { grid-column: span 2; } }
        @media (max-width: 800px)  { .span-3 { grid-column: span 1; } }

        /* â”€â”€ Card â”€â”€ */
        .card {
            background: rgba(30,30,47,0.9); border-radius: 12px;
            padding: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.04);
        }
        .card-header {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 12px; padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .card-header h2 { font-size: 1em; color: #00d4ff; font-weight: 600; }

        /* â”€â”€ Status Rows â”€â”€ */
        .status-grid { display: grid; gap: 8px; }
        .status-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 12px; background: rgba(255,255,255,0.03); border-radius: 6px;
        }
        .status-label { color: #777; font-size: 0.85em; }
        .status-value { font-weight: 600; font-size: 0.9em; }

        /* Status colors */
        .s-WORKING        { color: #4CAF50; }
        .s-IDLE           { color: #888; }
        .s-INTERRUPTED    { color: #ffaa00; }
        .s-WAITING_CONFIRM{ color: #00d4ff; }
        .s-COMPLETED      { color: #00ff88; }
        .s-NEXT_PHASE     { color: #9966ff; }
        .s-TERMINAL_RUNNING { color: #ff9800; }
        .s-ERROR          { color: #ff4444; }
        .s-CONNECTION_ERROR { color: #ff6b6b; }
        .s-PROVIDER_ERROR  { color: #ff8800; }
        .s-RESPONSE_STALL  { color: #cc6600; }
        .s-UNKNOWN        { color: #555; }

        /* Action colors */
        .a-send_task      { color: #00ff88; }
        .a-send_continue  { color: #ffaa00; }
        .a-start_phase    { color: #9966ff; }
        .a-wait           { color: #888; }
        .a-all_done       { color: #00d4ff; }
        .a-error_recovery { color: #ff4444; }

        /* â”€â”€ Progress Bar â”€â”€ */
        .progress-wrap { display: flex; align-items: center; gap: 10px; }
        .progress-bar {
            flex: 1; height: 6px; background: rgba(255,255,255,0.08);
            border-radius: 3px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; border-radius: 3px;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            transition: width 0.5s ease;
        }
        .progress-text { min-width: 50px; text-align: right; font-size: 0.85em; color: #aaa; }

        /* â”€â”€ Decision Box â”€â”€ */
        .decision-box {
            background: rgba(0,212,255,0.05); border-left: 3px solid #00d4ff;
            padding: 10px 14px; border-radius: 0 8px 8px 0;
        }
        .decision-title { color: #00d4ff; font-size: 0.8em; margin-bottom: 4px; }
        .decision-content { font-size: 0.9em; line-height: 1.5; }

        /* â”€â”€ Raw Response â”€â”€ */
        .raw-box {
            background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px;
            font-family: 'Consolas', 'Fira Code', monospace; font-size: 0.82em;
            line-height: 1.5; max-height: 120px; overflow-y: auto;
            white-space: pre-wrap; word-break: break-all;
        }

        /* â”€â”€ Screenshots â”€â”€ */
        .dual-screenshots { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .screenshot-item {
            background: rgba(255,255,255,0.02); border-radius: 8px; padding: 8px;
        }
        .screenshot-label {
            text-align: center; font-size: 0.78em; color: #666; margin-bottom: 6px;
        }
        .screenshot-box {
            width: 100%; min-height: 140px; background: rgba(0,0,0,0.3);
            border-radius: 6px; display: flex; align-items: center;
            justify-content: center; overflow: hidden; cursor: pointer;
        }
        .screenshot-box:hover { box-shadow: 0 0 8px rgba(0,212,255,0.2); }
        .screenshot-box img { max-width: 100%; max-height: 200px; object-fit: contain; }
        .screenshot-placeholder { color: #444; font-size: 0.85em; }
        .screenshot-time {
            text-align: center; font-size: 0.75em; color: #00d4ff;
            font-family: monospace; margin-top: 4px;
        }

        /* â”€â”€ Quadrant Grid (2Ã—2) â”€â”€ */
        .quad-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 6px;
        }
        .quad-cell {
            position: relative; border-radius: 6px; overflow: hidden;
            background: rgba(0,0,0,0.3); min-height: 100px;
            display: flex; align-items: center; justify-content: center;
        }
        .quad-cell img { max-width: 100%; max-height: 180px; object-fit: contain; }
        .quad-cell-label {
            position: absolute; top: 4px; left: 6px;
            font-size: 0.68em; padding: 1px 6px; border-radius: 3px;
            background: rgba(0,0,0,0.6); z-index: 2;
        }
        .quad-cell-status {
            position: absolute; bottom: 4px; right: 6px;
            font-size: 0.72em; padding: 1px 6px; border-radius: 3px;
            background: rgba(0,0,0,0.6); font-weight: 600; z-index: 2;
        }
        /* å·¦ä¾§è±¡é™ â€” ç½®ç°ä¸å¯ç‚¹å‡» */
        .quad-cell.disabled {
            opacity: 0.35; cursor: not-allowed; pointer-events: none;
        }
        .quad-cell.disabled::after {
            content: ''; position: absolute; inset: 0;
            background: rgba(50,50,60,0.5); z-index: 1;
        }
        /* å³ä¾§è±¡é™ â€” å¯ç‚¹å‡»æ”¾å¤§ */
        .quad-cell.active {
            cursor: pointer; border: 1px solid rgba(153,102,255,0.3);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .quad-cell.active:hover {
            border-color: rgba(153,102,255,0.8);
            box-shadow: 0 0 12px rgba(153,102,255,0.3);
        }

        /* â”€â”€ Lightbox Modal â”€â”€ */
        .lightbox-overlay {
            display: none; position: fixed; inset: 0; z-index: 9999;
            background: rgba(0,0,0,0.88); align-items: center; justify-content: center;
            cursor: zoom-out;
        }
        .lightbox-overlay.open { display: flex; }
        .lightbox-overlay img {
            max-width: 92vw; max-height: 92vh; object-fit: contain;
            border-radius: 8px; box-shadow: 0 0 40px rgba(0,212,255,0.2);
        }
        .lightbox-label {
            position: fixed; top: 16px; left: 50%; transform: translateX(-50%);
            color: #aaa; font-size: 0.9em; background: rgba(0,0,0,0.6);
            padding: 6px 20px; border-radius: 20px; z-index: 10000;
        }
        .lightbox-close {
            position: fixed; top: 16px; right: 24px; color: #888; font-size: 1.6em;
            cursor: pointer; z-index: 10000; background: rgba(0,0,0,0.5);
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            transition: color 0.2s;
        }
        .lightbox-close:hover { color: #fff; }

        /* â”€â”€ Logs â”€â”€ */
        .logs-box {
            max-height: 260px; overflow-y: auto;
            font-family: 'Consolas', monospace; font-size: 0.8em;
        }
        .log-entry {
            padding: 5px 8px; border-bottom: 1px solid rgba(255,255,255,0.03);
            display: flex; gap: 8px;
        }
        .log-time { color: #555; min-width: 62px; }
        .log-level { min-width: 48px; font-weight: 600; }
        .log-level.INFO    { color: #00d4ff; }
        .log-level.WARNING { color: #ffaa00; }
        .log-level.ERROR   { color: #ff4444; }
        .log-level.DEBUG   { color: #666; }
        .log-msg { flex: 1; word-break: break-all; }

        /* â”€â”€ Controls â”€â”€ */
        .ctrl-row {
            display: flex; gap: 8px; flex-wrap: wrap; align-items: center;
            margin-bottom: 10px;
        }
        .ctrl-label { color: #777; font-size: 0.85em; min-width: 60px; }
        .ctrl-input {
            flex: 1; min-width: 160px; padding: 8px 12px;
            border: 1px solid rgba(255,255,255,0.1); border-radius: 6px;
            background: rgba(0,0,0,0.2); color: #e0e0e0; font-size: 0.9em;
        }
        .ctrl-input:focus { outline: none; border-color: #00d4ff; }
        .ctrl-input-sm { width: 60px; min-width: 60px; flex: unset; text-align: center; }
        .btn {
            padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;
            font-size: 0.85em; font-weight: 600; transition: all 0.15s;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 3px 12px rgba(0,0,0,0.3); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
        .btn-primary { background: linear-gradient(135deg, #00d4ff, #0099cc); color: #fff; }
        .btn-success { background: linear-gradient(135deg, #00ff88, #00cc6a); color: #111; }
        .btn-warning { background: linear-gradient(135deg, #ffaa00, #ff8800); color: #111; }
        .btn-ghost  {
            background: transparent; border: 1px solid rgba(255,255,255,0.15); color: #aaa;
        }
        .btn-ghost:hover { border-color: #00d4ff; color: #00d4ff; }

        /* â”€â”€ Footer â”€â”€ */
        footer {
            text-align: center; padding: 12px; color: #444; font-size: 0.8em;
            margin-top: 16px;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- â•â•â• Header â•â•â• -->
    <header>
        <h1>DevPlan Executor</h1>
        <div class="subtitle">Cursor IDE æ— äººå€¼å®ˆè‡ªåŠ¨åŒ–ç›‘æ§</div>
        <div class="header-badges">
            <span class="badge">
                <span class="dot" id="runDot"></span>
                <span id="runLabel">--</span>
            </span>
            <span class="badge" id="badgeProject">é¡¹ç›®: --</span>
            <span class="badge" id="badgeExecutor">Executor: --</span>
            <span class="badge" id="badgeOverall">è¿›åº¦: --</span>
            <span class="countdown-badge" id="countdownBadge" title="è·ä¸‹æ¬¡æˆªå›¾åˆ†æ">
                <span class="countdown-ring"><span class="countdown-ring-fill" id="countdownRing"></span></span>
                <span>ä¸‹æ¬¡æˆªå›¾</span>
                <span class="countdown-num" id="countdownNum">--</span>
                <span style="color:#666">s</span>
            </span>
        </div>
    </header>

    <!-- â•â•â• Control Panel â•â•â• -->
    <div class="card" style="margin-bottom: 16px;">
        <div class="card-header"><h2>ğŸ® æ§åˆ¶é¢æ¿</h2></div>
        <div class="ctrl-row">
            <button class="btn btn-primary" onclick="findInput()">ğŸ¯ è¯†åˆ«è¾“å…¥æ¡†</button>
            <input class="ctrl-input" id="sendText" value="è¯·ç»§ç»­" placeholder="è¾“å…¥æ–‡æœ¬">
            <button class="btn btn-success" id="btnSend" onclick="sendText()">ğŸ“¤ å‘é€</button>
            <button class="btn btn-ghost" onclick="quickSend('è¯·ç»§ç»­')">è¯·ç»§ç»­</button>
        </div>
        <div class="ctrl-row">
            <span class="ctrl-label">æˆªå›¾é—´éš”</span>
            <input class="ctrl-input ctrl-input-sm" type="number" id="intervalInput" value="1.5" min="0.5" max="10" step="0.5">
            <span style="color:#666;font-size:0.85em">ç§’</span>
            <button class="btn btn-ghost" onclick="applyInterval()">åº”ç”¨</button>
            <span style="flex:1"></span>
            <span class="ctrl-label">å¯åŠ¨é˜¶æ®µ</span>
            <input class="ctrl-input ctrl-input-sm" style="width:100px" id="phaseInput" placeholder="phase-X">
            <button class="btn btn-warning" onclick="startPhase()">ğŸš€ å¯åŠ¨</button>
        </div>
    </div>

    <!-- â•â•â• Main Grid â•â•â• -->
    <div class="main-grid">

        <!-- â”€â”€â”€ DevPlan çŠ¶æ€ â”€â”€â”€ -->
        <div class="card">
            <div class="card-header"><h2>ğŸ“‹ DevPlan çŠ¶æ€</h2></div>
            <div class="status-grid">
                <div class="status-row">
                    <span class="status-label">å½“å‰é˜¶æ®µ</span>
                    <span class="status-value" id="phaseInfo">--</span>
                </div>
                <div class="status-row">
                    <span class="status-label">é˜¶æ®µè¿›åº¦</span>
                    <div class="progress-wrap">
                        <div class="progress-bar"><div class="progress-fill" id="phaseFill" style="width:0"></div></div>
                        <span class="progress-text" id="phaseText">0/0</span>
                    </div>
                </div>
                <div class="status-row">
                    <span class="status-label">å½“å‰ä»»åŠ¡</span>
                    <span class="status-value" id="taskInfo" style="font-size:0.85em">--</span>
                </div>
                <div class="status-row">
                    <span class="status-label">å»ºè®®åŠ¨ä½œ</span>
                    <span class="status-value" id="devplanAction">--</span>
                </div>
            </div>
            <div style="margin-top:10px;font-size:0.82em;color:#666" id="devplanMsg"></div>
        </div>

        <!-- â”€â”€â”€ UI è§†è§‰çŠ¶æ€ â”€â”€â”€ -->
        <div class="card">
            <div class="card-header"><h2>ğŸ‘ï¸ UI è§†è§‰çŠ¶æ€</h2></div>
            <div class="status-grid">
                <div class="status-row">
                    <span class="status-label">å±å¹•çŠ¶æ€</span>
                    <span class="status-value" id="uiStatus">--</span>
                </div>
                <div class="status-row">
                    <span class="status-label">å±å¹•å˜åŒ–</span>
                    <span class="status-value" id="screenChange">--</span>
                </div>
                <div class="status-row">
                    <span class="status-label">é‡è¯•è®¡æ•°</span>
                    <span class="status-value" id="retryCount">0</span>
                </div>
            </div>
            <div style="margin-top:10px;">
                <div style="color:#666;font-size:0.8em;margin-bottom:4px">æ¨¡å‹å“åº”</div>
                <div class="raw-box" id="rawResponse">ç­‰å¾…åˆ†æ...</div>
            </div>
        </div>

        <!-- â”€â”€â”€ å†³ç­–å¼•æ“ â”€â”€â”€ -->
        <div class="card">
            <div class="card-header"><h2>ğŸ§  å†³ç­–å¼•æ“</h2></div>
            <div class="decision-box" style="margin-bottom:12px">
                <div class="decision-title">æœ€ç»ˆåŠ¨ä½œ</div>
                <div class="decision-content" id="decisionAction" style="font-size:1.1em;font-weight:700">--</div>
            </div>
            <div class="decision-box" style="border-left-color:#666">
                <div class="decision-title">å†³ç­–åŸå› </div>
                <div class="decision-content" id="decisionMsg">--</div>
            </div>
        </div>

        <!-- â”€â”€â”€ æˆªå›¾å¯¹æ¯” â”€â”€â”€ -->
        <div class="card span-2">
            <div class="card-header"><h2>ğŸ“¸ è¿ç»­æˆªå›¾å¯¹æ¯”</h2></div>
            <div class="dual-screenshots">
                <div class="screenshot-item">
                    <div class="screenshot-label">æˆªå›¾ 1ï¼ˆT+0sï¼‰</div>
                    <div class="screenshot-box" id="ssBox1"><span class="screenshot-placeholder">ç­‰å¾…æˆªå›¾...</span></div>
                    <div class="screenshot-time" id="ssTime1">--:--:--</div>
                </div>
                <div class="screenshot-item">
                    <div class="screenshot-label" id="ss2Label">æˆªå›¾ 2ï¼ˆT+1.5sï¼‰</div>
                    <div class="screenshot-box" id="ssBox2"><span class="screenshot-placeholder">ç­‰å¾…æˆªå›¾...</span></div>
                    <div class="screenshot-time" id="ssTime2">--:--:--</div>
                </div>
            </div>
            <!-- å››è±¡é™æ¨¡å¼ï¼š2Ã—2 ç½‘æ ¼ -->
            <div id="quadSection" style="display:none; margin-top: 14px; border-top: 1px solid rgba(255,255,255,0.06); padding-top: 12px;">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                    <span style="color:#9966ff; font-size:0.85em; font-weight:600;">ğŸ”² å››è±¡é™åˆ†æ</span>
                    <span style="color:#555; font-size:0.75em;">å·¦ä¾§ï¼ˆè¾¹æ ï¼‰è·³è¿‡ Â· å³ä¾§ï¼ˆå†…å®¹åŒºï¼‰â†’ AI è¯†åˆ« Â· ç‚¹å‡»å³ä¾§å¯æ”¾å¤§</span>
                </div>
                <div class="quad-grid">
                    <!-- å·¦ä¸Š â€” ç½®ç°ä¸å¯ç‚¹å‡» -->
                    <div class="quad-cell disabled" id="quadTLCell">
                        <span class="quad-cell-label" style="color:#666;">å·¦ä¸Š Â· è¾¹æ </span>
                        <span id="quadTLImg" class="screenshot-placeholder">ä¸åˆ†æ</span>
                    </div>
                    <!-- å³ä¸Š â€” å¯ç‚¹å‡»æ”¾å¤§ -->
                    <div class="quad-cell active" id="quadTRCell" onclick="openLightbox('quadTRImg','å³ä¸Šï¼ˆä»£ç ç¼–è¾‘åŒºï¼‰')">
                        <span class="quad-cell-label" style="color:#9966ff;">å³ä¸Š Â· ç¼–è¾‘åŒº</span>
                        <span class="quad-cell-status" id="quadTRStatus">--</span>
                        <span id="quadTRImg" class="screenshot-placeholder">ç­‰å¾…æˆªå›¾...</span>
                    </div>
                    <!-- å·¦ä¸‹ â€” ç½®ç°ä¸å¯ç‚¹å‡» -->
                    <div class="quad-cell disabled" id="quadBLCell">
                        <span class="quad-cell-label" style="color:#666;">å·¦ä¸‹ Â· è¾¹æ </span>
                        <span id="quadBLImg" class="screenshot-placeholder">ä¸åˆ†æ</span>
                    </div>
                    <!-- å³ä¸‹ â€” å¯ç‚¹å‡»æ”¾å¤§ï¼ˆæœ€é‡è¦ï¼‰ -->
                    <div class="quad-cell active" id="quadBRCell" onclick="openLightbox('quadBRImg','å³ä¸‹ï¼ˆè¾“å…¥æ¡†+å¼¹çª—ï¼‰â­')" style="border-color:rgba(153,102,255,0.5);">
                        <span class="quad-cell-label" style="color:#ff9800;">å³ä¸‹ Â· è¾“å…¥æ¡† â­</span>
                        <span class="quad-cell-status" id="quadBRStatus">--</span>
                        <span id="quadBRImg" class="screenshot-placeholder">ç­‰å¾…æˆªå›¾...</span>
                    </div>
                </div>
            </div>
        </div>

    <!-- â•â•â• Lightbox Modal â•â•â• -->
    <div class="lightbox-overlay" id="lightboxOverlay" onclick="closeLightbox()">
        <span class="lightbox-label" id="lightboxLabel"></span>
        <span class="lightbox-close" onclick="closeLightbox()">âœ•</span>
        <img id="lightboxImg" src="" alt="æ”¾å¤§é¢„è§ˆ">
    </div>

        <!-- â”€â”€â”€ æ—¥å¿— â”€â”€â”€ -->
        <div class="card span-3">
            <div class="card-header"><h2>ğŸ“ è¿è¡Œæ—¥å¿—</h2></div>
            <div class="logs-box" id="logsBox">
                <div class="log-entry">
                    <span class="log-time">--:--:--</span>
                    <span class="log-level INFO">INFO</span>
                    <span class="log-msg">ç­‰å¾…å¯åŠ¨...</span>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <span>æœ€åæ›´æ–°: <span id="lastUpdate">--:--:--</span></span>
    </footer>
</div>

<script>
const STATUS_NAMES = {
    WORKING:'å·¥ä½œä¸­', IDLE:'ç©ºé—²', INTERRUPTED:'å·²ä¸­æ–­', WAITING_CONFIRM:'ç­‰å¾…ç¡®è®¤',
    COMPLETED:'å·²å®Œæˆ', NEXT_PHASE:'é˜¶æ®µå®Œæˆ', TERMINAL_RUNNING:'ç»ˆç«¯è¿è¡Œä¸­',
    ERROR:'é”™è¯¯', CONNECTION_ERROR:'è¿æ¥é”™è¯¯', PROVIDER_ERROR:'Provideré”™è¯¯',
    RESPONSE_STALL:'å“åº”åœæ»', UNKNOWN:'æœªçŸ¥',
};
const ACTION_NAMES = {
    send_task:'å‘é€ä»»åŠ¡', send_continue:'å‘é€ç»§ç»­', start_phase:'å¯åŠ¨é˜¶æ®µ',
    wait:'ç­‰å¾…ä¸­', all_done:'å…¨éƒ¨å®Œæˆ', error_recovery:'é”™è¯¯æ¢å¤',
};

function updateUI(d) {
    // Header badges
    const runDot = document.getElementById('runDot');
    runDot.className = 'dot ' + (d.running ? 'green' : 'red');
    document.getElementById('runLabel').textContent = d.running ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
    document.getElementById('badgeProject').textContent = 'é¡¹ç›®: ' + (d.project_name || '--');
    document.getElementById('badgeExecutor').textContent = 'Executor: ' + (d.executor_id || '--');
    document.getElementById('badgeOverall').textContent = 'è¿›åº¦: ' + (d.overall_progress || '--');

    // DevPlan çŠ¶æ€
    const phaseStr = d.current_phase ? (d.current_phase + ' â€” ' + (d.current_phase_title||'')) : '--';
    document.getElementById('phaseInfo').textContent = phaseStr;

    const pp = (d.phase_progress || '0/0').split('/');
    const done = parseInt(pp[0]) || 0, total = parseInt(pp[1]) || 0;
    const pct = total > 0 ? (done / total * 100) : 0;
    document.getElementById('phaseFill').style.width = pct + '%';
    document.getElementById('phaseText').textContent = d.phase_progress || '0/0';

    const taskStr = d.current_task_id ? (d.current_task_id + ': ' + (d.current_task_title||'')) : '--';
    document.getElementById('taskInfo').textContent = taskStr;

    const daEl = document.getElementById('devplanAction');
    daEl.textContent = ACTION_NAMES[d.devplan_action] || d.devplan_action || '--';
    daEl.className = 'status-value a-' + (d.devplan_action || '');
    document.getElementById('devplanMsg').textContent = d.devplan_message || '';

    // UI è§†è§‰çŠ¶æ€
    const usEl = document.getElementById('uiStatus');
    usEl.textContent = STATUS_NAMES[d.ui_status] || d.ui_status || '--';
    usEl.className = 'status-value s-' + (d.ui_status || '');
    document.getElementById('screenChange').textContent = d.screen_changing ? 'æœ‰å˜åŒ– ğŸŸ¢' : 'æ— å˜åŒ– âšª';
    document.getElementById('retryCount').textContent = d.continue_retries || 0;
    document.getElementById('rawResponse').textContent = d.raw_response || 'ç­‰å¾…åˆ†æ...';

    // å†³ç­–å¼•æ“
    const decEl = document.getElementById('decisionAction');
    decEl.textContent = ACTION_NAMES[d.decision_action] || d.decision_action || '--';
    decEl.className = 'decision-content a-' + (d.decision_action || '');
    document.getElementById('decisionMsg').textContent = d.decision_message || '--';

    // æˆªå›¾é—´éš”å’Œæ—¶é—´ï¼ˆæˆªå›¾ base64 ç”±ç‹¬ç«‹ /api/screenshots æ‹‰å–ï¼‰
    if (d.screenshot_time_1) document.getElementById('ssTime1').textContent = d.screenshot_time_1;
    if (d.screenshot_time_2) document.getElementById('ssTime2').textContent = d.screenshot_time_2;
    if (d.screenshot_interval) {
        document.getElementById('intervalInput').value = d.screenshot_interval;
        document.getElementById('ss2Label').textContent = 'æˆªå›¾ 2ï¼ˆT+' + d.screenshot_interval + 'sï¼‰';
    }

    // å››è±¡é™æ¨¡å¼ï¼ˆçŠ¶æ€æ ‡ç­¾ç”± SSE æ›´æ–°ï¼Œæˆªå›¾ç”±ç‹¬ç«‹ç«¯ç‚¹æ‹‰å–ï¼‰
    const quadSec = document.getElementById('quadSection');
    if (d.split_quadrant) {
        quadSec.style.display = 'block';
        const trStatusEl = document.getElementById('quadTRStatus');
        trStatusEl.textContent = STATUS_NAMES[d.quad_top_right_status] || d.quad_top_right_status || '--';
        trStatusEl.className = 'quad-cell-status s-' + (d.quad_top_right_status || '');
        const brStatusEl = document.getElementById('quadBRStatus');
        brStatusEl.textContent = STATUS_NAMES[d.quad_bottom_right_status] || d.quad_bottom_right_status || '--';
        brStatusEl.className = 'quad-cell-status s-' + (d.quad_bottom_right_status || '');
    } else {
        quadSec.style.display = 'none';
    }

    // æ—¥å¿—
    if (d.logs && d.logs.length) {
        const html = [...d.logs].reverse().map(l =>
            '<div class="log-entry">' +
            '<span class="log-time">' + l.time + '</span>' +
            '<span class="log-level ' + l.level + '">' + l.level + '</span>' +
            '<span class="log-msg">' + l.message + '</span></div>'
        ).join('');
        document.getElementById('logsBox').innerHTML = html;
    }

    document.getElementById('lastUpdate').textContent = d.last_update || '--:--:--';

    // â”€â”€ å®¢æˆ·ç«¯å€’è®¡æ—¶ï¼ˆç”±æœåŠ¡å™¨ä¿¡å·è§¦å‘ï¼Œæœ¬åœ°æ¯ç§’é€’å‡ï¼‰ â”€â”€
    const serverCountdown = d.next_tick_countdown || 0;
    const interval = d.poll_interval || 15;
    if (serverCountdown > 0 && _cdLocalValue <= 0) {
        // æœåŠ¡å™¨é€šçŸ¥å€’è®¡æ—¶å¼€å§‹ â†’ å¯åŠ¨æœ¬åœ°å®šæ—¶å™¨
        _cdStartLocal(serverCountdown, interval);
    } else if (serverCountdown <= 0 && _cdLocalValue > 0) {
        // æœåŠ¡å™¨é€šçŸ¥å€’è®¡æ—¶ç»“æŸï¼ˆæ­£åœ¨åˆ†æï¼‰â†’ åœæ­¢æœ¬åœ°å®šæ—¶å™¨
        _cdStopLocal();
    }
}

// â•â•â• å®¢æˆ·ç«¯å€’è®¡æ—¶ç®¡ç† â•â•â•
let _cdLocalValue = 0;      // å½“å‰æœ¬åœ°å€’è®¡æ—¶å€¼
let _cdTimerId = null;       // å®šæ—¶å™¨ ID
let _cdTotalInterval = 15;   // æ€»é—´éš”ï¼ˆç”¨äºè¿›åº¦ç¯è®¡ç®—ï¼‰

function _cdStartLocal(seconds, total) {
    _cdLocalValue = seconds;
    _cdTotalInterval = total || seconds;
    _cdStopLocal();  // å…ˆæ¸…ç†æ—§å®šæ—¶å™¨
    _cdRender();
    _cdTimerId = window.setInterval(() => {
        _cdLocalValue--;
        if (_cdLocalValue <= 0) {
            _cdLocalValue = 0;
            _cdStopLocal();
        }
        _cdRender();
    }, 1000);
}

function _cdStopLocal() {
    if (_cdTimerId) {
        clearInterval(_cdTimerId);
        _cdTimerId = null;
    }
}

function _cdRender() {
    const cdEl = document.getElementById('countdownNum');
    const cdBadge = document.getElementById('countdownBadge');
    const cdRing = document.getElementById('countdownRing');
    if (_cdLocalValue > 0) {
        cdEl.textContent = _cdLocalValue;
        cdBadge.classList.remove('active');
        cdBadge.title = 'è·ä¸‹æ¬¡æˆªå›¾åˆ†æ ' + _cdLocalValue + ' ç§’';
        const angle = 360 * (1 - _cdLocalValue / _cdTotalInterval);
        cdRing.style.transform = 'rotate(' + angle + 'deg)';
    } else {
        cdEl.textContent = 'â³';
        cdBadge.classList.add('active');
        cdBadge.title = 'æ­£åœ¨æˆªå›¾åˆ†æä¸­...';
        cdRing.style.transform = 'rotate(0deg)';
    }
}

// â•â•â• SSEï¼ˆè½»é‡çŠ¶æ€æ¨é€ï¼Œä¸å«æˆªå›¾ base64ï¼‰ â•â•â•
function connectSSE() {
    const es = new EventSource('/api/stream');
    es.onmessage = e => updateUI(JSON.parse(e.data));
    es.onerror = () => { console.log('SSE æ–­å¼€ï¼Œ3s åé‡è¿'); setTimeout(connectSSE, 3000); };
}

// â•â•â• æˆªå›¾ç‹¬ç«‹æ‹‰å–ï¼ˆæ¯ 5 ç§’ä¸€æ¬¡ï¼Œå‡å°‘ SSE å¸¦å®½ï¼‰ â•â•â•
let _lastScreenshotTime1 = '';
function fetchScreenshots() {
    fetch('/api/screenshots').then(r => r.json()).then(d => {
        // åªåœ¨æˆªå›¾æœ‰å˜åŒ–æ—¶æ›´æ–° DOMï¼ˆé¿å…å›¾ç‰‡é—ªçƒï¼‰
        if (d.screenshot1 && d.screenshot_time_1 !== _lastScreenshotTime1) {
            _lastScreenshotTime1 = d.screenshot_time_1;
            // å…¨å±æˆªå›¾
            document.getElementById('ssBox1').innerHTML = '<img src="data:image/png;base64,' + d.screenshot1 + '">';
            document.getElementById('ssBox2').innerHTML = '<img src="data:image/png;base64,' + d.screenshot2 + '">';
            if (d.screenshot_time_1) document.getElementById('ssTime1').textContent = d.screenshot_time_1;
            if (d.screenshot_time_2) document.getElementById('ssTime2').textContent = d.screenshot_time_2;
        }
        // å››è±¡é™æˆªå›¾ï¼ˆç‹¬ç«‹åˆ¤æ–­ï¼Œå¯èƒ½å’Œå…¨å±æˆªå›¾ä¸åŒæ—¶æ›´æ–°ï¼‰
        if (d.quad_top_left) {
            const el = document.getElementById('quadTLImg');
            if (el) el.outerHTML = '<img id="quadTLImg" src="data:image/png;base64,' + d.quad_top_left + '">';
        }
        if (d.quad_top_right) {
            const el = document.getElementById('quadTRImg');
            if (el) el.outerHTML = '<img id="quadTRImg" src="data:image/png;base64,' + d.quad_top_right + '">';
        }
        if (d.quad_bottom_left) {
            const el = document.getElementById('quadBLImg');
            if (el) el.outerHTML = '<img id="quadBLImg" src="data:image/png;base64,' + d.quad_bottom_left + '">';
        }
        if (d.quad_bottom_right) {
            const el = document.getElementById('quadBRImg');
            if (el) el.outerHTML = '<img id="quadBRImg" src="data:image/png;base64,' + d.quad_bottom_right + '">';
        }
    }).catch(() => {});
}

// â•â•â• åˆå§‹åŒ– â•â•â•
fetch('/api/state').then(r => r.json()).then(d => {
    updateUI(d);
    fetchScreenshots();
    connectSSE();
    // å®šæœŸæ‹‰å–æˆªå›¾ï¼ˆæ¯ 5 ç§’ï¼‰
    window.setInterval(fetchScreenshots, 5000);
});

// Controls
function findInput() {
    fetch('/api/find_input', {method:'POST'}).then(r=>r.json()).then(d => {
        alert(d.success ? 'å·²å®šä½è¾“å…¥æ¡†' : 'å¤±è´¥: ' + d.message);
    });
}
function sendText() {
    const text = document.getElementById('sendText').value || 'è¯·ç»§ç»­';
    const btn = document.getElementById('btnSend');
    btn.disabled = true; btn.textContent = 'â³';
    fetch('/api/send_text', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({text})
    }).then(r=>r.json()).then(d => {
        btn.textContent = d.success ? 'âœ…' : 'âŒ';
        setTimeout(() => { btn.innerHTML = 'ğŸ“¤ å‘é€'; btn.disabled = false; }, 1500);
    }).catch(() => {
        btn.innerHTML = 'ğŸ“¤ å‘é€'; btn.disabled = false;
    });
}
function quickSend(t) { document.getElementById('sendText').value = t; sendText(); }
function applyInterval() {
    const v = parseFloat(document.getElementById('intervalInput').value) || 1.5;
    fetch('/api/set_interval', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({interval: v})
    }).then(r=>r.json()).then(d => {
        if (d.success) document.getElementById('ss2Label').textContent = 'æˆªå›¾ 2ï¼ˆT+' + d.interval + 'sï¼‰';
    });
}
function startPhase() {
    const id = document.getElementById('phaseInput').value.trim();
    if (!id) { alert('è¯·è¾“å…¥é˜¶æ®µ IDï¼Œå¦‚ phase-6'); return; }
    fetch('/api/start_phase', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({phaseId: id})
    }).then(r=>r.json()).then(d => {
        alert(d.success ? 'å·²å¯åŠ¨ ' + id : 'å¤±è´¥: ' + d.message);
    });
}

// â”€â”€ Lightbox (ç‚¹å‡»æ”¾å¤§) â”€â”€
function openLightbox(imgId, label) {
    const imgEl = document.getElementById(imgId);
    if (!imgEl || !imgEl.src) return;
    const overlay = document.getElementById('lightboxOverlay');
    document.getElementById('lightboxImg').src = imgEl.src;
    document.getElementById('lightboxLabel').textContent = label || '';
    overlay.classList.add('open');
}
function closeLightbox() {
    document.getElementById('lightboxOverlay').classList.remove('open');
}
// ESC å…³é—­
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeLightbox();
});
// å…¨å±æˆªå›¾ä¹Ÿå¯ç‚¹å‡»æ”¾å¤§
document.getElementById('ssBox1').addEventListener('click', function() {
    var img = this.querySelector('img');
    if (img) { openLightbox_src(img.src, 'æˆªå›¾ 1ï¼ˆå…¨å±ï¼‰'); }
});
document.getElementById('ssBox2').addEventListener('click', function() {
    var img = this.querySelector('img');
    if (img) { openLightbox_src(img.src, 'æˆªå›¾ 2ï¼ˆå…¨å±ï¼‰'); }
});
function openLightbox_src(src, label) {
    if (!src) return;
    document.getElementById('lightboxImg').src = src;
    document.getElementById('lightboxLabel').textContent = label || '';
    document.getElementById('lightboxOverlay').classList.add('open');
}
</script>
</body>
</html>
